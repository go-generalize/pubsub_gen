## PubSub

- 以下の手順を実行する前に`make init`が完了している必要があります。
- PubSubを利用するために必要なコード群を自動生成したり実際にAPIを叩いて操作したりするツール

### 使い方
#### pubsub_generator boilerplate
- struct名を指定して必要なファイルの基礎を作る
- 1つのstructが1つのtopicに結びついている
- GAEからPubSubに対してメッセージを投げるとCloud Functionsにてそれを処理する、と言った想定

```console
$ pubsub_generator boilerplate Task # go
$ cat infra/pubsub/test/test.go
// Code generated by pubsub generator DO NOT EDIT.
package test

//go:generate pubsub_generator gogen Test

type Test struct {
        
}
$ cat infra/functions/test/test.go
package test

import (
	"context"

	pubsub "github.com/ORG_NAME/REPO_NAME/server/infra/pubsub/test"
)

func init() {
	pubsub.Subscribe(&testSubscriber{})
}

var _ pubsub.Subscriber = &testSubscriber{}

type testSubscriber struct {
}

func (s *testSubscriber) Run(ctx context.Context, message *pubsub.Test) error {
	panic("not implemented")
}
```

`Test struct`の中身にPubSub経由で渡したい内容を書く(JSONエンコードされるためexportされている必要がある)
また、Cloud Functionsで実行したい内容をRunメソッドの中に書く。Cloud Functionsで実行しない場合はinfra/functions内部に生成されたものを削除する必要がある。

pubsub_generator boilerplateはオプションでディレクトリ名やパッケージ名を上書きすることができる。一度生成してしまえばそのstructに関しては再度生成し直すことはない。
```console
$ pubsub_generator boilerplate -help   
Usage of pubsub_generator:
  -d string
        Directory name for generated code(default: struct name in snake case)
  -f    Overwrite existing files
  -p string
        Package name for generated code(default: all chars in lower case)
```

#### pubsub_generator deploy
- Cloud Functionsへ関数をデプロイするためのコマンド
- infra/functionsにある関数をデプロイする
- infra/functions内のフォルダ名をinfra/pubsubと照らし合わせてtopic名を特定する
- Go Moduleモードでprivateリポジトリを利用するために内部でgo mod vendorを叩いたりファイルをコピーしている

```console
Usage of pubsub_generator:
  -dry-run
        Don't create actual resources(print the diff and exit)
  -options string
        Options for gcloud functions deploy
  -region string
        Region to deploy functions (default "asia-northeast1")
  -runtime string
        Runtime for Cloud Functions (default "go111")
```

#### pubsub_generator migrate
- PubSubのtopicのうち不足しているものを自動で作成する
- infra/pubsub以下の自動生成されたファイルを検索しtopicを生成する
- project-idオプションの指定が必須

```console
Usage of pubsub_generator:
  -dry-run
        Don't create actual resources(print the diff and exit)
  -project-id string
        Project ID for GCP
```
